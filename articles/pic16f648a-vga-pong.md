---
title: "PIC16F648A縛りでVGA出力してピンポンゲーム（PONG）を作った"
emoji: "🕌"
type: "tech"
topics: []
published: false
---
作ったもの
=====
人の声入ってたり手ぶれ補正のせいで画面ぐにゃぐにゃしてたりしますが勘弁してください。

https://youtu.be/jBsCnTp7_NU

有名なAtariのゲームをモチーフにしています。
実験の発表に使った都合上白黒だと印象に残りにくいと思い、少し色をつけています。

全てPICシリーズのアセンブリ言語MPASMを用いて実装しました。

↓原作に近い操作性を出すためにコントローラにはロータリーエンコーダーを採用しました。
>![Signed_Pong_Cabinet.jpg](/images/pic16f648a-vga-pong/292px-Signed_Pong_Cabinet.jpg =128x)
> By Chris Rand - Own work, CC BY-SA 3.0, https://commons.wikimedia.org/w/index.php?curid=28364913

レギュレーション
-----
- 予算2000円程度。
- マイコンは学校支給のPIC16F648Aのみ。
- 開発期間一ヶ月。

どのようにしてディスプレイに表示したか
=====

![main_overview.png](/images/pic16f648a-vga-pong/main_overview.png =256x)

VGAとは
-----
> ![547px-VGA_Stecker.jpg](/images/pic16f648a-vga-pong/547px-VGA_Stecker.jpg =256x)
> Afrank99 - 投稿者自身による作品, CC 表示-継承 2.5, https://commons.wikimedia.org/w/index.php?curid=360210による

少しでも自作パソコンに触ったことのある人なら、上図のコネクタを目にしたことがあると思います。
（古い規格なのでもう廃れてみた事ないかもしれませんが）

VGAとは上図のコネクタ（DSub15pin）を介してディスプレイがどんな画像を表示するべきか指示する規格です。
今回このVGAを採用した理由は
1. 規格がシンプルで理解しやすい点
2. ディスプレイが旧世代のもののため、安価に手に入る点
3. アナログ規格であるが、デジタル制御もでき、回路が簡単で済む点

因みに欠点は
1. フレームレートが60FPSで固定であること。
2. 縦方向の解像度が480pxで固定であること。

です。
これにより、解像度やフレームレートを下げてPICの負荷を下げるということができなくなるため実装にはかなり苦労しました。

因みに他に検討した規格としてNTSCがあります。
これはファミコンのような古めの機器で使われていた規格で、フレームレートが３０FPSのためPICの負荷を減らすことができます。
しかし、対応ディスプレイが生産終了により手に入りにくいこと、規格自体と回路が複雑に見えたことから一ヶ月での実装が困難と考え見送りました。

### VGA規格詳細
端子の構成は以下の図のようになっています。
15PINで多く感じますが、実際に制御が必要なのはこれだけであとはGNDと未使用ピンです。
未使用品が存在するのはVGAがDSUBという一般の規格の端子を使っているからです。

![dsub_port_annotated.png](/images/pic16f648a-vga-pong/dsub_port_annotated.png =256x)


回路図

![wave_diagram.jpeg](/images/pic16f648a-vga-pong/wave_diagram.jpeg =512x)

![wave_result.png](/images/pic16f648a-vga-pong/wave_result.png =256x)

VGA規格自体の解説は👇が詳しいです。
[VGA信号のタイミングチャート｜電子技術研究倶楽部](http://ele-tech.net/vga-doc1/)

一つ注意点として、垂直同期信号がLOWの間に色信号を入力しているとフィルターされます。
![wave_diagram_fail.jpeg](/images/pic16f648a-vga-pong/wave_diagram_fail.png =512x)

### 16色デコーダ
![16colors_decoder.png](/images/pic16f648a-vga-pong/16colors_decoder.png =512x)

4ビットの信号を分圧して色の信号を出してます。

入力|色|出力(赤-緑-青) [V]
-|-|:-:|
0x0|BLACK|0.00-0.00-0.00
0x1|DARKBLUE|0.00-0.00-0.29
0x2|DARKGREEN|0.00-0.29-0.00
0x3|DARKCYAN|0.00-0.29-0.29
0x4|DARKRED|0.29-0.00-0.00
0x5|DARKPURPLE|0.29-0.00-0.29
0x6|DARKYELLOW|0.29-0.29-0.00
0x7|DARKGRAY|0.29-0.29-0.29
0x8|GRAY|0.57-0.57-0.57
0x9|BLUE|0.00-0.00-0.86
0xA|GREEN|0.00-0.86-0.00
0xB|CYAN|0.00-0.86-0.86
0xC|RED|0.86-0.00-0.00
0xD|PURPLE|0.86-0.00-0.86
0xE|YELLOW|0.86-0.86-0.00
0xF|WHITE|0.86-0.86-0.86

0.86Vと少し定格(0.70V)をオーバーしてますが用意できた抵抗の関係です。動いたのでセーフ。

この回路を参考にラダー抵抗で作りました。予算２千円のため、ICが買えなかったためです。
[たびろぐテクニカル ラダー式DACとVGA](http://yuranos.blog11.fc2.com/blog-entry-116.html)

こっちは４食ですが、１６色にしてみました。
[最弱のPICでTV出力ーWentWayUp](https://wentwayup.tamaliver.jp/e326227.html)

### PIC内での処理
ラインバッファ方式を採用しています。
画像の保管形式


スプライト

その他
=====

音声
-----
これは特に特殊なことはしていません。
データをRETLWテーブルで保管し、PWMで復調して再生しています。

容量が4kBしかないので入りきる音声を探すのが大変でした。

通信
-----
UARTを38kHz赤外線で変調して、拡散キャップを被せて広範囲に届くようにしています。

PIC16F648AはUARTモジュールを一個しか持っていなかったので間にボーレート変換器を挟みました。

費用（大体）
=====
パーツをいくつか頂いたりしているのでいくらか余分にかかりますが、オーダー2500円程度で作れると思います。
ちなみにディスプレイはハードオフで550円で買えました。

|品目名|値段|数量|小計
|-|-|-|-
|PIC16F648A（追加）|280|1|280
74HC08|30|3|90
74HC14|40|2|80
74HC32|30|1|30
赤外線LED OSI5LA5113A 10個入り|100|0.4|40
LED光拡散キャップ(5mm) 白 (50個入り)|200|0.08|16
クリスタル（水晶発振子） ２０ＭＨｚ|30|4|120
22pF セラミックキャパシタ (10個入り)|100|0.8|80
赤外線リモコン受信モジュール GP1UXC41QS|50|1|50
VGA用基板ソケット 3列15P|80|1|80
3.5mm4極ミニジャック 基板取り付け用|46|1|46
クリスタルオシレータ（２０ＭＨｚ）ＳＧ－８００２ＤＣ（５Ｖ）|300|1|300
ロータリーエンコーダ（２４クリックタイプ）|80|2|160
カット基板片面紙フェノール|474|1|474
２．１ｍｍ標準ＤＣジャック（４Ａ）|40|1|40
三端子レギュレーター ５Ｖ１．５Ａ ＮＪＭ７８０５ＦＡ|50|1|50
低損失ＣＭＯＳ三端子レギュレータ ３．３Ｖ５００ｍＡ ＮＪＵ７２２３Ｆ３３|50|1|50
|||合計|1986

感想
=====
アセンブリデバッグ地獄で一ヶ月しんどかった。
